import requests
from io import BytesIO
from zipfile import ZipFile
import os
import re
try:
    from Integrations.mispIntegration import *
except:
    from mispIntegration import *

def delete_file(file_path):
    try:
        os.remove(file_path)
    except OSError as e:
        print(f"Error deleting file '{file_path}': {e}")
def download_and_extract(url, destination_folder):
    response = requests.get(url)
    if response.status_code == 200:
        with ZipFile(BytesIO(response.content)) as zip_file:
            zip_file.extractall(destination_folder)
    else:
        print(f"Failed to download file. Status code: {response.status_code}")
    with open("Integrations/full_sha256.txt","r") as f:
        ioc_list=f.readlines()
    
    for j in ioc_list:
        sha256_regex = re.compile(r"^[a-fA-F0-9]{64}$")
        if sha256_regex.match(j):
            upload_attr(j)
        else:
            pass
def runMalwareBazaar(mispapi,mispurl,mispeventid):
    misp_connect(mispapi,mispurl,mispeventid)
    zip_url = "https://bazaar.abuse.ch/export/txt/sha256/full/"
    destination_folder = "Integrations/"
    if not os.path.exists(destination_folder):
        os.makedirs(destination_folder)
    download_and_extract(zip_url, destination_folder)
    
if __name__=="__main__":
    if os.path.exists("MISP/Info"):
        with open("MISP/Info","r") as f:
            a=f.readlines()
            MISPAPI=a[0].split("MISPAPI:")[1].strip()
            MISPURL=a[1].split("MISPURL:")[1].strip()
            MISPEVENTID=a[2].split("MISPEVENTID:")[1].strip()
            runMalwareBazaar(MISPAPI,MISPURL,MISPEVENTID)